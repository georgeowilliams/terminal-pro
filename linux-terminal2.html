<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Linux Terminal Expert — Mini Course</title>
  <style>
    :root{
      --bg: #0b1020;
      --panel: #0f1630;
      --panel2:#111b3a;
      --text: #e6e6e6;
      --muted:#a7b0cc;
      --accent:#7aa2ff;
      --accent2:#88f0c7;
      --warn:#ffd57a;
      --danger:#ff7a7a;
      --border: rgba(255,255,255,0.08);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 900px at 30% 10%, #152252 0%, var(--bg) 50%, #070a14 100%);
      color: var(--text);
    }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .app{
      display:grid;
      grid-template-columns: 320px 1fr;
      min-height:100vh;
    }
    .sidebar{
      border-right:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      padding:18px 14px;
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:14px;
    }
    .logo{
      width:40px;height:40px;border-radius:10px;
      background: linear-gradient(145deg, rgba(122,162,255,0.35), rgba(136,240,199,0.25));
      border:1px solid var(--border);
      display:grid; place-items:center;
      font-family: var(--mono);
      color: var(--accent2);
      font-weight:700;
    }
    .brand h1{
      font-size:14px; margin:0; letter-spacing:0.2px;
    }
    .brand .sub{
      font-size:12px; color: var(--muted); margin-top:2px;
    }
    .search{
      margin:10px 0 14px;
      display:flex;
      gap:8px;
    }
    .search input{
      width:100%;
      padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      outline:none;
      font-family: var(--mono);
      font-size:12px;
    }
    .chiprow{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:14px; }
    .chip{
      font-size:11px;
      border:1px solid var(--border);
      padding:6px 8px;
      border-radius:999px;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      color: var(--text);
      border-color: rgba(122,162,255,0.35);
      background: rgba(122,162,255,0.12);
    }
    .toc-title{
      font-size:12px;
      color: var(--muted);
      margin:14px 4px 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .toc{
      display:flex;
      flex-direction:column;
      gap:8px;
      padding-bottom:14px;
    }
    .toc-item{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.02);
      border-radius:12px;
      padding:10px 10px;
      cursor:pointer;
      transition: transform 0.05s ease, border-color 0.15s ease, background 0.15s ease;
    }
    .toc-item:hover{
      background: rgba(255,255,255,0.04);
      transform: translateY(-1px);
    }
    .toc-item.active{
      border-color: rgba(136,240,199,0.35);
      background: rgba(136,240,199,0.08);
    }
    .toc-item .kicker{
      font-size:10px;
      color: var(--muted);
      letter-spacing:0.5px;
      text-transform:uppercase;
      margin-bottom:4px;
    }
    .toc-item .title{
      font-size:13px;
      margin:0;
      line-height:1.25;
    }
    .toc-item .meta{
      margin-top:6px;
      font-size:11px;
      color: var(--muted);
      font-family: var(--mono);
    }

    .main{
      padding:22px 22px 40px;
      overflow:auto;
    }
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .crumbs{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .crumbs .small{
      font-size:12px; color: var(--muted);
    }
    .crumbs .big{
      font-size:18px; font-weight:700;
    }
    .navbtns{
      display:flex;
      gap:10px;
      align-items:center;
    }
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-family: var(--mono);
      font-size:12px;
    }
    button:hover{ background: rgba(255,255,255,0.06); }
    button:disabled{ opacity:0.45; cursor:not-allowed; }
    .progresswrap{
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(255,255,255,0.02);
      overflow:hidden;
      height:12px;
      width:240px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(122,162,255,0.9), rgba(136,240,199,0.9));
    }

    .card{
      border:1px solid var(--border);
      border-radius:16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015));
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .content{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .content h2{
      margin:0;
      font-size:16px;
    }
    .content p{
      margin:0;
      color: var(--text);
      line-height:1.55;
    }
    .content ul{ margin:0; padding-left:18px; color: var(--text); }
    .content li{ margin:6px 0; }

    pre, code{
      font-family: var(--mono);
      font-size:12px;
    }
    pre{
      margin:0;
      padding:14px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.35);
      overflow:auto;
      line-height:1.35;
    }
    .hint{
      border-left:3px solid rgba(122,162,255,0.7);
      padding:10px 12px;
      border-radius:10px;
      background: rgba(122,162,255,0.10);
      color: var(--text);
    }
    .warn{
      border-left:3px solid rgba(255,213,122,0.8);
      background: rgba(255,213,122,0.10);
    }
    .danger{
      border-left:3px solid rgba(255,122,122,0.8);
      background: rgba(255,122,122,0.10);
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      font-size:11px;
      font-family: var(--mono);
      width:max-content;
    }
    .footer{
      margin-top:14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size:12px;
      font-family: var(--mono);
    }
    .kbd{
      border:1px solid var(--border);
      border-bottom-color: rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.03);
      padding:2px 6px;
      border-radius:6px;
      font-family: var(--mono);
      color: var(--text);
      font-size:11px;
    }
    .term{
      border-bottom: 1px dotted rgba(136,240,199,0.7);
      background: rgba(136,240,199,0.08);
      cursor: help;
      border-radius: 4px;
      padding: 0 2px;
      transition: background 0.15s ease, border-color 0.15s ease;
    }
    .term:hover,
    .term:focus-visible{
      background: rgba(136,240,199,0.22);
      border-bottom-color: rgba(136,240,199,1);
      outline: none;
    }
    .tooltip{
      position: fixed;
      z-index: 2000;
      width: min(360px, calc(100vw - 24px));
      border: 1px solid var(--border);
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(24,33,67,0.96), rgba(13,19,42,0.96));
      box-shadow: 0 18px 36px rgba(0,0,0,0.42);
      padding: 12px;
      display: none;
    }
    .tooltip.open{ display:block; }
    .tooltip-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .tooltip-title{ margin:0; font-size:14px; }
    .tooltip-close{ padding:4px 8px; font-size:11px; }
    .tooltip-short{ color: var(--text); margin:0 0 8px; line-height:1.4; }
    .tooltip-more-btn{
      background:none;
      border:none;
      color:var(--accent2);
      padding:0;
      font-size:12px;
      cursor:pointer;
      font-family: var(--mono);
    }
    .tooltip-more{ display:none; margin-top:8px; color: var(--muted); line-height:1.45; }
    .tooltip-more.open{ display:block; }
    .tooltip-see{ margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; }
    .see-chip{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(122,162,255,0.14);
      color: var(--text);
      cursor:pointer;
    }
    .glossary-wrap{
      display:grid;
      gap:12px;
    }
    .glossary-search{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      font-family: var(--mono);
    }
    .glossary-list{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap:8px;
    }
    .glossary-item{
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px;
      background: rgba(255,255,255,0.03);
      cursor:pointer;
      text-align:left;
      color:var(--text);
    }
    .glossary-empty{ color: var(--muted); font-style: italic; }
    .settings{
      margin-top: 14px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background: rgba(255,255,255,0.03);
      display:grid;
      gap:8px;
    }
    .settings .label{ font-size:11px; color:var(--muted); font-family:var(--mono); }
    .settings button{ width:100%; }
    button:focus-visible, .chip:focus-visible, .glossary-item:focus-visible, .toc-item:focus-visible { outline: 2px solid var(--accent2); outline-offset: 2px; }
    .complete-badge{ color: var(--accent2); font-weight:700; margin-left:6px; }
    .quiz-wrap{ border-top:1px solid var(--border); margin-top:8px; padding-top:14px; display:grid; gap:12px; }
    .quiz-card{ border:1px solid var(--border); border-radius:12px; padding:12px; background: rgba(255,255,255,0.02); }
    .quiz-card h4{ margin:0 0 8px; font-size:14px; }
    .quiz-choices{ display:grid; gap:6px; margin:8px 0; }
    .quiz-feedback{ margin-top:8px; font-size:12px; }
    .quiz-feedback.ok{ color: var(--accent2); }
    .quiz-feedback.bad{ color: var(--danger); }
    .quiz-answer{ margin-top:8px; }
    .quiz-answer pre{ margin-top:6px; }
    .practice-on .content > p,
    .practice-on .content > ul { opacity:0.86; }
    .drill-task{ border:1px dashed var(--border); border-radius:10px; padding:10px; background:rgba(122,162,255,0.08); }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .progresswrap{ width:160px; }
      .grid2{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">&gt;_</div>
      <div>
        <h1>Linux Terminal Expert</h1>
        <div class="sub">Interactive notes + navigation</div>
      </div>
    </div>

    <div class="search">
      <input id="search" placeholder="Search lessons (e.g. grep, ssh, tmux, permissions)..." />
    </div>

    <div class="chiprow" id="chiprow"></div>

    <div class="settings">
      <div class="label">Learning Settings</div>
      <button id="practiceToggle" type="button">Practice Mode: OFF</button>
      <button id="resetProgressBtn" type="button">Reset progress</button>
    </div>

    <div class="toc-title">
      <span>Index</span>
      <span id="count" style="color: var(--muted); font-family: var(--mono); font-size:11px;"></span>
    </div>

    <div class="toc" id="toc"></div>

    <div class="hint warn" style="margin-top:14px;">
      Tip: Use <span class="kbd">/</span> to focus search, <span class="kbd">J</span>/<span class="kbd">K</span> to move, <span class="kbd">←</span>/<span class="kbd">→</span> for prev/next.
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="crumbs">
        <div class="small" id="kicker">Module</div>
        <div class="big" id="title">Title</div>
      </div>

      <div class="navbtns">
        <div class="progresswrap" title="Progress">
          <div class="bar" id="bar"></div>
        </div>
        <button id="completeBtn">Mark complete ✓</button>
        <button id="prevBtn">← Prev</button>
        <button id="nextBtn">Next →</button>
      </div>
    </div>

    <div class="card">
      <div class="content" id="content"></div>
      <div class="footer">
        <div id="footerLeft"></div>
        <div id="footerRight"></div>
      </div>
    </div>
  </main>
</div>

<div class="tooltip" id="termTooltip" role="dialog" aria-live="polite" aria-label="Term definition"></div>

<script>
  // --- Course Data ----------------------------------------------------------
  const lessons = [
    {
      id: "mindset",
      module: "0. Welcome",
      title: "How terminal pros think",
      tags: ["fundamentals","workflow"],
      content: `
<p>Becoming “terminal expert” is less about memorizing commands and more about building a <b>mental model</b>:</p>
<ul>
  <li><b>Everything is a file</b> (or a stream): config, devices, sockets, logs.</li>
  <li><b>Small tools + pipes</b>: compose commands like LEGO.</li>
  <li><b>Inspect first, then act</b>: preview before you delete/overwrite.</li>
</ul>

<pre>
ASCII model of streams + pipe composition:

stdin(0) -> [ tool A ] -> [ tool B ] -> [ tool C ] -> stdout(1)
                 |            |            |
               flags       filters     formatters

stderr(2) -------------------------------------> terminal

Redirect patterns:
  cmd > out.txt
  cmd 2> err.txt
  cmd > all.txt 2>&1
</pre>

<div class="hint">
Core pro habit: keep a scratch pad command:
<code>history | tail</code>, then refine.
</div>

<p><span class="pill">Pro tools you’ll adopt</span> <code>tmux</code>, <code>fzf</code>, <code>ripgrep</code>, <code>bat</code>, <code>fd</code>, <code>jq</code>, <code>ssh</code>, <code>git</code></p>
`
    },

    {
      id: "navigation",
      module: "1. Movement & Discovery",
      title: "Navigation: files, paths, and fast jumping",
      tags: ["fundamentals","filesystem"],
      content: `
<p>Learn to move like a native:</p>
<ul>
  <li><code>pwd</code>, <code>ls</code>, <code>cd</code> basics — but the pro upgrades are <code>eza</code>, <code>zoxide</code>, and fuzzy finding.</li>
  <li>Use <code>pushd</code>/<code>popd</code> like a stack for directories.</li>
</ul>

<div class="grid2">
<pre>
Filesystem tree mental model:

/ (root)
├─ home/
│  ├─ you/
│  │  ├─ projects/
│  │  └─ downloads/
├─ dev/
├─ proc/
└─ etc/
   ├─ ssh/
   └─ systemd/
</pre>

<pre>
Fast jumping (recommended):

zoxide (z) remembers directories:
  z proj
  z iso

fzf fuzzy search:
  cd "$(find . -type d | fzf)"
</pre>
</div>

<div class="hint warn">
If you install one “quality of life” tool first, make it <b>fzf</b>. It upgrades everything.
</div>
`
    },

    {
      id: "help",
      module: "2. Reading the System",
      title: "Getting help: man, tldr, and discoverability",
      tags: ["fundamentals","docs"],
      content: `
<p>Pros don’t guess. They query documentation fast.</p>
<ul>
  <li><code>man rsync</code> (full manual)</li>
  <li><code>tldr rsync</code> (quick examples)</li>
  <li><code>command --help</code> (fast flags overview)</li>
  <li><code>apropos keyword</code> or <code>man -k keyword</code></li>
</ul>

<pre>
ASCII: How to learn a command in 30 seconds

1) tldr curl
2) man curl  (search inside man: /pattern)
3) try a tiny example
4) add flags one at a time
</pre>

<p><span class="pill">Pro libraries/tools</span> <code>tldr</code>, <code>man</code>, <code>info</code>, <code>cheat</code></p>
`
    },

    {
      id: "text",
      module: "3. Text as Data",
      title: "Pipes, grep, rg, awk, sed, sort, uniq",
      tags: ["text","search"],
      content: `
<p>Your superpower: turn text streams into answers.</p>

<div class="grid2">
<pre>
Pipeline anatomy:

cat file.txt
| rg "error|warn"
| sort
| uniq -c
| sort -nr
</pre>

<pre>
Modern defaults:

rg  = ripgrep (faster grep)
fd  = friendlier find
bat = better cat (syntax highlighting)
</pre>
</div>

<p>Practice drills:</p>
<ul>
  <li>Find all TODOs: <code>rg -n "TODO|FIXME" .</code></li>
  <li>Top 20 largest files: <code>du -ah . | sort -hr | head -20</code></li>
  <li>Extract a column: <code>awk '{print $2}'</code></li>
</ul>

<div class="hint">
When you’re stuck: print intermediate output after each pipe step.
</div>

<p><span class="pill">Pro libraries/tools</span> <code>ripgrep (rg)</code>, <code>awk</code>, <code>sed</code>, <code>sort</code>, <code>uniq</code>, <code>column</code></p>
`
    },

    {
      id: "globbing",
      module: "4. Shell Power",
      title: "Globs, quoting, variables, and exit codes",
      tags: ["shell","fundamentals"],
      content: `
<p>This is where most “not quite expert” users break things. Learn these rules:</p>

<pre>
Globs (shell expands them):

*.log     matches log files
**/*.js   recursive glob (depends on shell)
{a,b}.txt brace expansion -> a.txt b.txt

Quoting:
"..." keeps spaces, still expands $VARS
'...' literal (no expansions)
\\ escapes next character
</pre>

<pre>
Exit codes:

0   success
!=0 failure

Chain logic:
cmd1 && cmd2   (only run cmd2 if cmd1 succeeded)
cmd1 || cmd2   (run cmd2 if cmd1 failed)
</pre>

<div class="hint danger">
If a path might contain spaces, quote it: <code>"$path"</code>
</div>

<p><span class="pill">Pro libraries/tools</span> <code>shellcheck</code> (lint), <code>bash</code>/<code>zsh</code>, <code>direnv</code> (env per folder)</p>
`
    },

    {
      id: "permissions",
      module: "5. Ownership & Permissions",
      title: "chmod, chown, umask (and why sudo is not a hammer)",
      tags: ["security","filesystem"],
      content: `
<p>Permissions are a 3×3 grid: <b>user</b>, <b>group</b>, <b>others</b> with <b>rwx</b>.</p>

<pre>
Permissions grid:

        r  w  x
user    1  1  1
group   1  0  1
other   0  0  0

-rwxr-x---  file
 ^^^ ^^^ ^^^
 u   g   o

Octal map: r=4 w=2 x=1
7=rwx 5=r-x 0=---

chmod 750 file
</pre>

<pre>
Ownership flow:

[user alice] ---- member of ----> [devops group]
      |                              |
 owns deploy.sh                 can read logs/

chown alice:devops deploy.sh
</pre>

<ul>
  <li><code>chown user:group file</code></li>
  <li><code>umask</code> controls default permission masking</li>
  <li>Prefer least privilege over “sudo everything”</li>
</ul>

<div class="hint warn">
A strong pro habit: understand who owns a file before fixing it.
Try: <code>ls -la</code>
</div>
`
    },

    {
      id: "processes",
      module: "6. Processes & Performance",
      title: "ps, top/htop, kill, signals, jobs",
      tags: ["process","performance"],
      content: `
<p>Learn how Linux runs your programs.</p>

<div class="grid2">
<pre>
Process tree + signals flow:

terminal ---- spawns ----> shell ---- spawns ----> program
   |                          |
 Ctrl+C                    jobs/bg/fg
   |
 sends SIGINT --------------> program

Inspect:
ps aux | rg node
pstree -p

Signals:
SIGINT, SIGTERM, SIGKILL
</pre>

<pre>
Jobs (in your shell):

cmd &
jobs
fg %1
bg %1
disown
</pre>
</div>

<p><span class="pill">Pro libraries/tools</span> <code>htop</code>/<code>btop</code>, <code>strace</code>, <code>lsof</code>, <code>time</code></p>
`
    },

    {
      id: "networking",
      module: "7. Networking Basics",
      title: "curl, wget, ssh, scp/rsync, ports and DNS",
      tags: ["network","security"],
      content: `
<p>Terminal pros can diagnose network issues quickly.</p>

<pre>
Networking path:

you -> DNS -> IP -> TCP handshake -> service:port -> response
         |                        |
      name->addr               443/22/80

Socket map:
client:ephemeral_port -> server:443
</pre>

<pre>
Ports cheat:

22  -> SSH
80  -> HTTP
443 -> HTTPS
53  -> DNS
</pre>

<ul>
  <li><code>curl -I https://example.com</code> headers</li>
  <li><code>dig example.com</code> DNS query</li>
  <li><code>ss -tulpn</code> listening ports</li>
  <li><code>ssh user@host</code> remote shell</li>
  <li><code>rsync -avz</code> fast sync, resumable</li>
</ul>

<p><span class="pill">Pro libraries/tools</span> <code>openssh</code>, <code>rsync</code>, <code>mtr</code>, <code>tcpdump</code>, <code>nmap</code> (responsible use)</p>
`
    },

    {
      id: "git",
      module: "8. Version Control",
      title: "Git fundamentals for terminal workflow",
      tags: ["git","workflow"],
      content: `
<p>If you build anything (you do), git is part of being a terminal pro.</p>

<pre>
Core loop:
git status
git diff
git add -p
git commit -m "message"
git push
</pre>

<pre>
ASCII: commits are a chain

A -- B -- C -- D (main)
      \\
       E -- F     (feature)
</pre>

<p>Recommended tools:</p>
<ul>
  <li><code>delta</code> for nicer diffs</li>
  <li><code>lazygit</code> if you like a terminal UI</li>
</ul>
`
    },

    {
      id: "tmux",
      module: "9. Multiplexing",
      title: "tmux: sessions, panes, and muscle memory",
      tags: ["workflow","tmux"],
      content: `
<p><b>tmux</b> is how terminal pros keep context and speed.</p>

<pre>
tmux model:

session: work
  ├─ window: editor
  │   ├─ pane 1
  │   └─ pane 2
  └─ window: logs
      └─ pane 3

+---------------------------+
| pane 1       | pane 2     |
|--------------+------------|
| pane 3                    |
+---------------------------+
</pre>

<pre>
Key chords map:

Ctrl+b c   new window
Ctrl+b %   split vertical
Ctrl+b "   split horizontal
Ctrl+b o   rotate panes
</pre>

<ul>
  <li>Start: <code>tmux</code></li>
  <li>New session: <code>tmux new -s work</code></li>
  <li>Detach: <code>Ctrl+b</code> then <code>d</code></li>
  <li>Reattach: <code>tmux a -t work</code></li>
</ul>

<div class="hint">
Pro tip: keep one session per project: <code>work</code>, <code>infra</code>, <code>notes</code>.
</div>
`
    },

    {
      id: "dotfiles",
      module: "10. Professional Setup",
      title: "Dotfiles: shell config, prompt, aliases, and safety rails",
      tags: ["workflow","shell","security"],
      content: `
<p>Pros build guardrails and repeatability.</p>

<ul>
  <li><b>Shell</b>: bash or zsh</li>
  <li><b>Prompt</b>: starship (fast, cross-shell)</li>
  <li><b>Aliases</b>: short and safe (avoid hidden magic)</li>
  <li><b>Functions</b>: for workflows (git, ssh, logs)</li>
</ul>

<pre>
Recommended "safe defaults" aliases:

alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'

# Better tools:
alias cat='bat'
alias ls='eza -lah'
</pre>

<p><span class="pill">Pro libraries/tools</span> <code>starship</code>, <code>zoxide</code>, <code>direnv</code>, <code>chezmoi</code> (dotfiles mgmt)</p>
`
    },

    {
      id: "parsing",
      module: "11. Structured Data",
      title: "jq, yq, and logs (JSON/YAML as first-class)",
      tags: ["data","logs"],
      content: `
<p>Modern ops/dev work is JSON everywhere. Learn <b>jq</b>.</p>

<pre>
Extract fields:
cat file.json | jq '.items[] | {id, name}'

Filter:
jq '.items[] | select(.status=="error")'
</pre>

<p>YAML tools vary; <code>yq</code> is common.</p>

<p><span class="pill">Pro libraries/tools</span> <code>jq</code>, <code>yq</code>, <code>python</code> (quick one-liners), <code>gron</code></p>
`
    },

    {
      id: "scripting",
      module: "12. Scripting",
      title: "Write reliable shell scripts (and avoid footguns)",
      tags: ["shell","automation","security"],
      content: `
<p>Script like a pro: predictable, safe, tested.</p>

<pre>
Baseline script headers:

#!/usr/bin/env bash
set -euo pipefail
IFS=$'\\n\\t'
</pre>

<ul>
  <li><code>shellcheck</code> everything</li>
  <li>Prefer <code>printf</code> over <code>echo</code> for portability</li>
  <li>Handle paths safely; quote variables</li>
</ul>

<div class="hint danger">
If you ever write: <code>rm -rf $VAR</code>
…you must ensure VAR is never empty. Consider checks.
</div>
`
    },

    {
      id: "tools",
      module: "13. Pro Toolbox",
      title: "The typical terminal-pro library stack",
      tags: ["workflow","tools"],
      content: `
<p>This is a pragmatic “pro stack” you’ll see in modern setups:</p>

<div class="grid2">
<pre>
Search & navigate:
  fzf, ripgrep (rg), fd, zoxide

Viewing:
  bat, eza, less (with -R), delta

Sessions:
  tmux

Data:
  jq, yq

Dev:
  git, gh (GitHub CLI), make

Quality:
  shellcheck, shfmt

Ops:
  ssh, rsync, curl, wget
</pre>

<pre>
Monitoring/debug:
  htop/btop
  lsof
  strace
  dmesg, journalctl
  nc (netcat)
</pre>
</div>

<p class="hint">
You don’t need them all on day 1. Learn in layers:
<b>rg + fzf + tmux</b> will 10× your speed quickly.
</p>
`
    },

    {
      id: "challenge",
      module: "14. Practice Path",
      title: "30-day drills to become dangerous (in a good way)",
      tags: ["practice","workflow"],
      content: `
<p>Here’s a simple training plan:</p>

<ul>
  <li><b>Days 1–5</b>: navigation + pipes (<code>rg</code>, <code>fd</code>, <code>sort</code>, <code>awk</code>)</li>
  <li><b>Days 6–10</b>: permissions + processes (<code>chmod</code>, <code>ps</code>, <code>kill</code>, <code>lsof</code>)</li>
  <li><b>Days 11–15</b>: networking (<code>curl</code>, <code>ssh</code>, <code>rsync</code>, <code>ss</code>)</li>
  <li><b>Days 16–20</b>: tmux + dotfiles (speed & repeatability)</li>
  <li><b>Days 21–30</b>: write scripts + automate (lint with shellcheck)</li>
</ul>

<pre>
ASCII: skill stack

      [automation/scripts]
   [data parsing + networking]
 [process + permissions + text]
     [navigation + shell]
</pre>

<div class="hint">
Pick one “real” project (e.g. log analysis, backups, deploy script) and build it over the month.
</div>
`
    },
  ];

  const quizBank = {
    mindset: [
      { type:"mcq", prompt:"What does `2> err.txt` do?", choices:["Redirect stdout to err.txt","Redirect stderr to err.txt","Append stdout to err.txt","Pipe stderr to the next command"], answerIndex:1, explanation:"File descriptor 2 is stderr, so `2>` redirects stderr." },
      { type:"short", prompt:"What command shows your recent command history tail?", answer:"history | tail", explanation:"This gives a quick scratchpad of recent commands." }
    ],
    navigation: [
      { type:"mcq", prompt:"What does `pushd`/`popd` help with?", choices:["File permissions","Directory stack navigation","Process signals","Port scanning"], answerIndex:1, explanation:"They manage a stack of directories for quick jumping." },
      { type:"short", prompt:"Use zoxide to jump to a folder remembered as proj.", answer:"z proj", explanation:"zoxide stores weighted directory history." }
    ],
    help: [
      { type:"mcq", prompt:"Which command lists manuals matching a keyword?", choices:["whereis keyword","man -k keyword","help keyword","which keyword"], answerIndex:1, explanation:"`man -k` (or apropos) searches man page names/descriptions." },
      { type:"short", prompt:"Open the quick examples for curl.", answer:"tldr curl", explanation:"tldr provides concise examples." }
    ],
    text: [
      { type:"short", prompt:"Find TODO recursively with line numbers in current folder.", answer:'rg -n "TODO" .', explanation:"ripgrep is recursive by default; -n prints line numbers." },
      { type:"output", prompt:"Predict output for `printf \"a\\na\\nb\\n\" | sort | uniq -c`", answer:"      2 a\n      1 b", explanation:"sort groups lines; uniq -c counts adjacent duplicates." }
    ],
    globbing: [
      { type:"mcq", prompt:"Which quote type prevents variable expansion?", choices:["Double quotes \"...\"","Single quotes '...'","Backticks","No quotes"], answerIndex:1, explanation:"Single quotes keep content literal in shell." },
      { type:"short", prompt:"Write a safe command to list a path stored in variable path that might contain spaces.", answer:'ls "$path"', explanation:"Quote variables that may include spaces." }
    ],
    permissions: [
      { type:"mcq", prompt:"What does chmod 750 grant to group?", choices:["rwx","r-x","rw-","---"], answerIndex:1, explanation:"7 user=rwx, 5 group=r-x, 0 others=---." },
      { type:"short", prompt:"Set owner user and group devops on deploy.sh.", answer:"chown user:devops deploy.sh", explanation:"Format is chown user:group file." }
    ],
    processes: [
      { type:"mcq", prompt:"Ctrl+C usually sends which signal?", choices:["SIGTERM","SIGKILL","SIGINT","SIGHUP"], answerIndex:2, explanation:"Interactive interrupt is SIGINT." },
      { type:"short", prompt:"Bring first background job to foreground.", answer:"fg %1", explanation:"job spec `%1` targets the first job." }
    ],
    networking: [
      { type:"mcq", prompt:"Default SSH port is:", choices:["80","22","443","53"], answerIndex:1, explanation:"SSH listens on TCP 22 by default." },
      { type:"short", prompt:"List listening ports and processes.", answer:"ss -tulpn", explanation:"ss provides socket and process details." }
    ],
    git: [
      { type:"mcq", prompt:"Which command stages patches interactively?", choices:["git add -p","git stage all","git patch","git commit -p"], answerIndex:0, explanation:"`git add -p` lets you stage hunks." },
      { type:"short", prompt:"Check repo state before committing.", answer:"git status", explanation:"Always inspect status before changes." }
    ],
    tmux: [
      { type:"mcq", prompt:"tmux key chord for new window (default prefix)?", choices:["Ctrl+b c","Ctrl+b %","Ctrl+b o","Ctrl+b d"], answerIndex:0, explanation:"Prefix Ctrl+b then c creates a window." },
      { type:"short", prompt:"Reattach to tmux session named work.", answer:"tmux a -t work", explanation:"`a` is shorthand for attach." }
    ],
    dotfiles: [
      { type:"mcq", prompt:"Which alias is a safety rail for delete?", choices:["alias rm='rm -i'","alias rm='rm -rf'","alias cp='cp -r'","alias mv='mv -f'"], answerIndex:0, explanation:"Interactive rm helps avoid accidental deletion." },
      { type:"short", prompt:"Set safer copy alias from the lesson.", answer:"alias cp='cp -i'", explanation:"-i prompts before overwrite." }
    ],
    parsing: [
      { type:"mcq", prompt:"Which tool is designed to query JSON on CLI?", choices:["awk","jq","grep","sed"], answerIndex:1, explanation:"jq is purpose-built for JSON." },
      { type:"short", prompt:"Select error-status items with jq (assuming array at .items).", answer:'jq ".items[] | select(.status==\"error\")"', explanation:"Select filters objects by predicate." }
    ],
    scripting: [
      { type:"mcq", prompt:"Which strict-mode header is recommended?", choices:["set -x","set -euo pipefail","set +e","set -f"], answerIndex:1, explanation:"`set -euo pipefail` is the baseline here." },
      { type:"short", prompt:"What command should you run to lint shell scripts?", answer:"shellcheck script.sh", explanation:"shellcheck catches common shell bugs." }
    ],
    tools: [
      { type:"mcq", prompt:"Which trio gives the fastest day-one speedup?", choices:["curl + ssh + rsync","rg + fzf + tmux","jq + yq + python","git + gh + make"], answerIndex:1, explanation:"The lesson calls out rg + fzf + tmux." },
      { type:"short", prompt:"Name one monitoring tool from the toolbox section.", answer:"htop", explanation:"Any listed tool (e.g., htop, lsof, strace) is valid." }
    ],
    challenge: [
      { type:"mcq", prompt:"Days 11–15 focus on which area?", choices:["Git workflows","Networking","Dotfiles","Permissions"], answerIndex:1, explanation:"The plan explicitly assigns networking to days 11–15." },
      { type:"short", prompt:"What should you pick and build over the month?", answer:"one real project", explanation:"A real project compounds skills across lessons." }
    ]
  };

  lessons.forEach(l => {
    if (quizBank[l.id]) l.quiz = quizBank[l.id];
  });

  const drillTasks = [
    "Find the 10 largest files under current directory.",
    "List listening ports with owning processes.",
    "Find TODO/FIXME lines in this repo.",
    "Show top 5 memory-consuming processes.",
    "Find files modified in the last 24 hours."
  ];

  // --- Glossary -------------------------------------------------------------
  const glossary = [
    { term: "file", aliases:["files"], short:"Named data stored on disk.", long:"A file is a sequence of bytes with metadata like owner and permissions.", seeAlso:["filesystem","path","permission"] },
    { term: "filesystem", aliases:["file system"], short:"Hierarchy used to organize files and directories.", long:"Linux exposes storage as a rooted tree that starts at / and contains mounted devices.", seeAlso:["directory","path","/etc","/proc"] },
    { term: "path", aliases:["pathname"], short:"Address to a file or directory.", long:"Paths can be absolute (/var/log) or relative (../src). The shell resolves them based on current directory.", examples:["cd /etc/ssh","cat ../notes.txt"], seeAlso:["directory","root"] },
    { term: "directory", aliases:["folder","directories"], short:"Container that holds files and other directories.", long:"Directories build the tree structure for the filesystem.", seeAlso:["filesystem","path"] },
    { term: "permission", aliases:["permissions"], short:"Read/write/execute access rules.", long:"Permissions are defined for user, group, and others and can be set with chmod.", seeAlso:["ownership","group","umask"] },
    { term: "ownership", aliases:["owner"], short:"User/group associated with a file.", long:"chown changes ownership. Ownership controls default permission interpretation.", seeAlso:["group","permission","sudo"] },
    { term: "group", aliases:["groups"], short:"Shared account role used in permissions.", long:"Users can be members of groups to share access to files and services.", seeAlso:["ownership","permission"] },
    { term: "root", aliases:["superuser"], short:"Administrative account with near-unrestricted access.", long:"root can bypass many permission checks, so use carefully.", seeAlso:["sudo","permission"] },
    { term: "sudo", aliases:[], short:"Run a command with elevated privileges.", long:"sudo executes one command as another user (default root), usually after policy checks.", seeAlso:["root","permission"] },
    { term: "umask", aliases:[], short:"Default permission mask for new files/dirs.", long:"umask removes permission bits from defaults (files 666, dirs 777).", seeAlso:["permission"] },
    { term: "stream", aliases:["streams"], short:"A flow of bytes through stdin/stdout/stderr.", long:"Unix tools read and write streams, making redirection and composition possible.", examples:["echo hi | wc -c","command > out.txt","command 2> err.txt"], seeAlso:["stdin","stdout","stderr","pipe","redirection"] },
    { term: "stdin", aliases:["standard input"], short:"Input stream (fd 0).", long:"Programs read data from stdin by default, often from keyboard or a pipe.", seeAlso:["stream","pipe"] },
    { term: "stdout", aliases:["standard output"], short:"Output stream (fd 1).", long:"Normal command output is written to stdout and can be redirected.", seeAlso:["stream","redirection"] },
    { term: "stderr", aliases:["standard error"], short:"Error stream (fd 2).", long:"Diagnostic output goes to stderr so it can be separated from normal output.", seeAlso:["stdout","redirection"] },
    { term: "pipe", aliases:["pipes"], short:"Connect stdout of one command to stdin of another.", long:"Pipes let you chain tiny tools into powerful workflows.", examples:["rg error app.log | sort | uniq -c"], seeAlso:["stream","redirection"] },
    { term: "redirection", aliases:["redirect"], short:"Send stdin/stdout/stderr to files/devices.", long:">, >>, <, and 2> control where data flows.", seeAlso:["stream","stdout","stderr"] },
    { term: "socket", aliases:["sockets"], short:"Endpoint for network communication.", long:"Sockets are file-like interfaces used by TCP/UDP and Unix domain communication.", seeAlso:["port","TCP","UDP"] },
    { term: "device file", aliases:["device"], short:"Special file representing hardware or pseudo-devices.", long:"/dev entries provide a file interface to devices (disk, terminal, null).", seeAlso:["/dev"] },
    { term: "/dev", aliases:[], short:"Directory of device files.", long:"Contains pseudo/devices like /dev/null and /dev/tty.", seeAlso:["device file"] },
    { term: "/proc", aliases:[], short:"Virtual filesystem exposing process/kernel info.", long:"Read-only-ish runtime data such as /proc/cpuinfo and /proc/<pid>.", seeAlso:["PID","process"] },
    { term: "/etc", aliases:[], short:"System-wide configuration directory.", long:"Global config files for services and tools usually live under /etc.", seeAlso:["filesystem","service"] },
    { term: "daemon", aliases:["daemons"], short:"Background service process.", long:"Daemons run without interactive terminals and often start at boot.", seeAlso:["service","process"] },
    { term: "service", aliases:["services"], short:"Managed long-running process.", long:"systemd and similar tools supervise services and their lifecycle.", seeAlso:["daemon"] },
    { term: "signal", aliases:["signals"], short:"Async notification sent to a process.", long:"Signals like SIGINT/SIGTERM instruct processes to stop, reload, or handle events.", seeAlso:["process","job control"] },
    { term: "process", aliases:["processes"], short:"Running program instance.", long:"Each process has a PID, parent process, environment, and open files.", seeAlso:["PID","signal"] },
    { term: "PID", aliases:["pid"], short:"Process identifier number.", long:"Unique numeric ID for a running process.", seeAlso:["process"] },
    { term: "job control", aliases:["jobs"], short:"Shell controls for foreground/background jobs.", long:"Use Ctrl+Z, bg, fg, and jobs to manage interactive processes.", seeAlso:["signal","process"] },
    { term: "port", aliases:["ports"], short:"Numeric endpoint on a host.", long:"Ports identify specific network services (e.g., 22 SSH, 443 HTTPS).", seeAlso:["socket","TCP","UDP","SSH"] },
    { term: "DNS", aliases:["dns"], short:"Name system mapping domains to IPs.", long:"DNS resolves human-readable names to IP addresses before connecting.", seeAlso:["TCP","UDP"] },
    { term: "TCP", aliases:["tcp"], short:"Reliable connection-oriented transport protocol.", long:"TCP performs handshake, ordering, and retransmission.", seeAlso:["UDP","port"] },
    { term: "UDP", aliases:["udp"], short:"Connectionless transport protocol.", long:"UDP is low overhead and used for DNS, streaming, and telemetry.", seeAlso:["TCP"] },
    { term: "SSH", aliases:["ssh"], short:"Secure Shell for remote login/commands.", long:"SSH provides encrypted terminal access, port forwarding, and file transfer.", seeAlso:["port","service"] },
    { term: "glob", aliases:["globs"], short:"Shell wildcard pattern matching.", long:"Patterns like *.log are expanded by the shell before command execution.", seeAlso:["quoting"] },
    { term: "quoting", aliases:["quote"], short:"Control shell interpretation of characters.", long:"Single and double quotes change expansion behavior for variables and spaces.", seeAlso:["glob","environment variable"] },
    { term: "environment variable", aliases:["env var","environment variables"], short:"Named value inherited by child processes.", long:"Variables like PATH and HOME configure command behavior.", seeAlso:["process","exit code"] },
    { term: "exit code", aliases:["exit status"], short:"Numeric success/failure result from a command.", long:"0 usually means success; nonzero indicates errors or special states.", seeAlso:["process"] },
    { term: "JSON", aliases:["json"], short:"Structured text data format.", long:"Common for APIs, logs, and config; parsed with jq.", seeAlso:["jq","YAML"] },
    { term: "YAML", aliases:["yaml"], short:"Human-friendly structured text format.", long:"Used heavily for config and infra manifests.", seeAlso:["JSON"] },
    { term: "jq", aliases:[], short:"Command-line JSON processor.", long:"jq filters, transforms, and queries JSON streams.", seeAlso:["JSON","YAML"] },
    { term: "commit", aliases:["commits"], short:"Snapshot in git history.", long:"A commit records staged changes plus message, author, and parent.", seeAlso:["branch","HEAD","staging area"] },
    { term: "branch", aliases:["branches"], short:"Movable pointer to a commit chain.", long:"Branches isolate work and can be merged or rebased.", seeAlso:["commit","HEAD"] },
    { term: "HEAD", aliases:["head"], short:"Current checked-out commit pointer.", long:"HEAD usually points to the current branch tip.", seeAlso:["branch","staging area"] },
    { term: "staging area", aliases:["index"], short:"Git area prepared for next commit.", long:"git add puts changes in the index before commit.", seeAlso:["commit","HEAD"] },
    { term: "tmux session", aliases:["session"], short:"Persistent tmux workspace.", long:"Sessions contain windows/panes and survive terminal disconnects.", seeAlso:["tmux window","tmux pane"] },
    { term: "tmux window", aliases:["window"], short:"Tab-like container within a tmux session.", long:"Each window can hold one or more panes.", seeAlso:["tmux session","tmux pane"] },
    { term: "tmux pane", aliases:["pane","panes"], short:"Split terminal region inside tmux.", long:"Panes let you view multiple commands simultaneously.", seeAlso:["tmux session","tmux window"] },
    { term: "fzf", aliases:[], short:"Fuzzy finder for interactive selection.", long:"fzf provides fast fuzzy filtering for files, history, processes, and more." },
    { term: "ripgrep", aliases:["rg"], short:"Fast recursive text search tool.", long:"ripgrep replaces many grep/find combos with speed and smart defaults." },
    { term: "fd", aliases:[], short:"User-friendly alternative to find.", long:"fd has simpler syntax and good default ignore behavior." },
    { term: "bat", aliases:[], short:"Improved cat with syntax highlighting.", long:"bat shows files with line numbers, colors, and paging support." }
  ];

  const glossaryByKey = new Map(glossary.map(item => [item.term.toLowerCase(), item]));
  const aliasIndex = new Map();
  glossary.forEach(item => {
    [item.term, ...(item.aliases || [])].forEach(alias => aliasIndex.set(alias.toLowerCase(), item.term.toLowerCase()));
  });

  // --- UI State -------------------------------------------------------------
  const allLessons = [...lessons,
    {id:"daily-drills",module:"15. Reference",title:"Daily Drills",tags:["reference","practice"],content:""},
    {id:"glossary",module:"16. Reference",title:"Glossary",tags:["reference","fundamentals"],content:""}
  ];
  const storageKeys = {
    practiceMode: "terminalCourse.v2.practiceMode",
    complete: "terminalCourse.v2.completedLessons",
    lessonPrefix: "terminalCourse.v2.lesson."
  };
  const state = {
    filterTag: "All",
    search: "",
    visible: [...allLessons],
    currentIndex: 0,
    tooltipTermKey: null,
    practiceMode: localStorage.getItem(storageKeys.practiceMode) === "1",
    completedLessons: new Set(JSON.parse(localStorage.getItem(storageKeys.complete) || "[]"))
  };
  const annotatedCache = new Map();

  // --- Elements -------------------------------------------------------------
  const tocEl = document.getElementById("toc");
  const titleEl = document.getElementById("title");
  const kickerEl = document.getElementById("kicker");
  const contentEl = document.getElementById("content");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const barEl = document.getElementById("bar");
  const footerLeft = document.getElementById("footerLeft");
  const footerRight = document.getElementById("footerRight");
  const searchEl = document.getElementById("search");
  const chiprowEl = document.getElementById("chiprow");
  const countEl = document.getElementById("count");
  const tooltipEl = document.getElementById("termTooltip");
  const practiceToggleBtn = document.getElementById("practiceToggle");
  const resetProgressBtn = document.getElementById("resetProgressBtn");
  const completeBtn = document.getElementById("completeBtn");

  // --- Helpers --------------------------------------------------------------
  const uniqueTags = () => {
    const s = new Set();
    allLessons.forEach(l => l.tags.forEach(t => s.add(t)));
    return ["All", ...Array.from(s).sort()];
  };

  function normalizeTerm(raw){
    return aliasIndex.get(String(raw || "").toLowerCase()) || null;
  }

  function lessonStorageKey(lessonId){
    return `${storageKeys.lessonPrefix}${lessonId}.quizState`;
  }

  function readQuizState(lessonId){
    try {
      return JSON.parse(localStorage.getItem(lessonStorageKey(lessonId)) || "{}");
    } catch {
      return {};
    }
  }

  function writeQuizState(lessonId, payload){
    localStorage.setItem(lessonStorageKey(lessonId), JSON.stringify(payload));
  }

  function saveCompleted(){
    localStorage.setItem(storageKeys.complete, JSON.stringify(Array.from(state.completedLessons)));
  }

  function setPracticeMode(on){
    state.practiceMode = !!on;
    localStorage.setItem(storageKeys.practiceMode, on ? "1" : "0");
    document.body.classList.toggle("practice-on", state.practiceMode);
    practiceToggleBtn.textContent = `Practice Mode: ${state.practiceMode ? "ON" : "OFF"}`;
  }

  function normalizeAnswer(value){
    return String(value || "").trim().replace(/\s+/g, " ").toLowerCase();
  }

  function seededPick(list, seed){
    if (!list.length) return null;
    let h = 0;
    for (let i = 0; i < seed.length; i++) h = (h * 31 + seed.charCodeAt(i)) >>> 0;
    return list[h % list.length];
  }

  function allQuizQuestions(){
    return lessons.flatMap(lesson => (lesson.quiz || []).map((q, idx) => ({lessonId: lesson.id, lessonTitle: lesson.title, idx, q})));
  }

  function createDailyDrillsHTML(){
    const seed = state.drillSeed || new Date().toISOString().slice(0,10);
    const term = seededPick(glossary, `${seed}:term`);
    const quizPick = seededPick(allQuizQuestions(), `${seed}:quiz`);
    const task = seededPick(drillTasks, `${seed}:task`);
    return `
      <h2>Daily Drills</h2>
      <p>Seed for today: <code>${escapeHtml(seed)}</code></p>
      <div class="drill-task"><b>Glossary drill:</b> <span>${escapeHtml(term.term)}</span> — ${escapeHtml(term.short)}<br/>Use it in a command of your own.</div>
      <div class="drill-task"><b>Quiz drill:</b> ${escapeHtml(quizPick.lessonTitle)} — ${escapeHtml(quizPick.q.prompt)}</div>
      <div class="drill-task"><b>Tiny task:</b> ${escapeHtml(task)}</div>
      <button type="button" id="newDrillBtn">New set</button>
    `;
  }

  function renderQuizSection(lesson){
    if (!lesson.quiz?.length) return "";
    const quizState = readQuizState(lesson.id);
    const cards = lesson.quiz.map((q, idx) => {
      const qState = quizState[idx] || {};
      const prompt = annotateTerms(`<span>${escapeHtml(q.prompt)}</span>`, `${lesson.id}-q-${idx}-p`);
      const explanation = qState.revealed || qState.checked ? `<div class="quiz-answer">${annotateTerms(`<span>${escapeHtml(q.explanation || "")}</span>`, `${lesson.id}-q-${idx}-e`)}</div>` : "";
      if (q.type === "mcq") {
        const options = q.choices.map((choice, cidx) => `<label><input type="radio" name="${lesson.id}-q-${idx}" data-quiz-choice="${cidx}" ${String(qState.selectedIndex)===String(cidx)?"checked":""}/> ${escapeHtml(choice)}</label>`).join("");
        const feedback = qState.checked ? `<div class="quiz-feedback ${qState.correct ? "ok" : "bad"}">${qState.correct ? "Correct" : "Not yet"}</div>` : "";
        return `<div class="quiz-card" data-quiz-index="${idx}"><h4>Question ${idx+1}</h4><p>${prompt}</p><div class="quiz-choices">${options}</div><button type="button" data-quiz-action="check">Check answer</button>${feedback}${explanation}</div>`;
      }
      if (q.type === "output") {
        const user = escapeHtml(qState.userAnswer || "");
        const compare = (qState.revealed && qState.userAnswer) ? `<pre>${escapeHtml(String(q.answer))}</pre>` : "";
        return `<div class="quiz-card" data-quiz-index="${idx}"><h4>Question ${idx+1}</h4><p>${prompt}</p><textarea data-quiz-input="output" rows="4" style="width:100%; font-family:var(--mono);">${user}</textarea><div><button type="button" data-quiz-action="compare">Compare</button> <button type="button" data-quiz-action="reveal">Reveal answer</button></div>${compare}${explanation}</div>`;
      }
      const shortVal = escapeHtml(qState.userAnswer || "");
      return `<div class="quiz-card" data-quiz-index="${idx}"><h4>Question ${idx+1}</h4><p>${prompt}</p><input data-quiz-input="short" value="${shortVal}" style="width:100%;"/><div><button type="button" data-quiz-action="reveal">Reveal answer</button></div>${qState.revealed ? `<div class="quiz-answer"><code>${escapeHtml(q.answer)}</code></div>` : ""}${explanation}</div>`;
    }).join("");
    return `<section class="quiz-wrap"><h2>${state.practiceMode ? "Practice" : "Lesson Quiz"}</h2>${cards}</section>`;
  }

  function updateLessonCompletion(lesson){
    if (!lesson?.id) return;
    const quiz = lesson.quiz || [];
    if (!quiz.length) return;
    const s = readQuizState(lesson.id);
    const complete = quiz.every((q, idx) => {
      const qState = s[idx] || {};
      return q.type === "mcq" ? qState.checked : qState.revealed;
    });
    if (complete) state.completedLessons.add(lesson.id);
    saveCompleted();
  }

  function applyFilters() {
    const q = state.search.trim().toLowerCase();
    const tag = state.filterTag;
    const currentId = getCurrentLesson()?.id;

    state.visible = allLessons.filter(l => {
      const matchesTag = (tag === "All") ? true : l.tags.includes(tag);
      const base = l.id === "glossary" ? createGlossaryPageHTML() : (l.id === "daily-drills" ? createDailyDrillsHTML() : l.content);
      const blob = (l.module + " " + l.title + " " + l.tags.join(" ") + " " + stripHtml(base)).toLowerCase();
      const matchesQ = q ? blob.includes(q) : true;
      return matchesTag && matchesQ;
    });

    if (state.visible.length === 0) {
      state.currentIndex = 0;
    } else {
      const newIndex = currentId ? state.visible.findIndex(x => x.id === currentId) : 0;
      state.currentIndex = (newIndex >= 0) ? newIndex : Math.min(state.currentIndex, state.visible.length - 1);
    }

    renderToc();
    renderLesson();
  }

  function stripHtml(html){
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
  }

  function getCurrentLesson(){
    return state.visible[state.currentIndex] || state.visible[0] || null;
  }

  function setCurrentById(id){
    const idx = state.visible.findIndex(l => l.id === id);
    if (idx >= 0){
      state.currentIndex = idx;
      renderLesson();
      renderToc();
      updateUrlHash();
    }
  }

  function updateUrlHash(){
    const l = getCurrentLesson();
    if (!l) return;
    history.replaceState(null, "", "#" + encodeURIComponent(l.id));
  }

  function escapeRegex(str){
    return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function annotateTerms(htmlString, lessonId){
    if (annotatedCache.has(lessonId)) return annotatedCache.get(lessonId);
    const parser = new DOMParser();
    const doc = parser.parseFromString(`<div id="root">${htmlString}</div>`, "text/html");
    const root = doc.getElementById("root");
    const entries = [];
    glossary.forEach(item => {
      [item.term, ...(item.aliases || [])].forEach(alias => entries.push({ alias, key: item.term.toLowerCase() }));
    });
    entries.sort((a,b) => b.alias.length - a.alias.length);
    const combined = entries.map(e => escapeRegex(e.alias)).join("|");
    const regex = new RegExp(`\b(${combined})\b`, "gi");

    const walker = doc.createTreeWalker(root, NodeFilter.SHOW_TEXT);
    const replaceTargets = [];
    while(walker.nextNode()){
      const node = walker.currentNode;
      if (!node.nodeValue || !node.nodeValue.trim()) continue;
      const parent = node.parentElement;
      if (!parent) continue;
      if (parent.closest("pre, code, a, .term, button, input, textarea")) continue;
      replaceTargets.push(node);
    }

    for (const node of replaceTargets){
      regex.lastIndex = 0;
      const text = node.nodeValue;
      if (!regex.test(text)) continue;
      regex.lastIndex = 0;
      const frag = doc.createDocumentFragment();
      let last = 0;
      let m;
      while((m = regex.exec(text))){
        const before = text.slice(last, m.index);
        if (before) frag.appendChild(doc.createTextNode(before));
        const match = m[0];
        const key = normalizeTerm(match);
        if (key){
          const span = doc.createElement("span");
          span.className = "term";
          span.setAttribute("data-term", key);
          span.setAttribute("tabindex", "0");
          span.setAttribute("role", "button");
          span.textContent = match;
          frag.appendChild(span);
        } else {
          frag.appendChild(doc.createTextNode(match));
        }
        last = regex.lastIndex;
      }
      const after = text.slice(last);
      if (after) frag.appendChild(doc.createTextNode(after));
      node.parentNode.replaceChild(frag, node);
    }

    const out = root.innerHTML;
    annotatedCache.set(lessonId, out);
    return out;
  }

  function createGlossaryPageHTML(){
    return `
      <h2>Glossary</h2>
      <p>Search terms and open mini wiki cards.</p>
      <div class="glossary-wrap">
        <input id="glossarySearch" class="glossary-search" placeholder="Search glossary terms..." />
        <div id="glossaryList" class="glossary-list"></div>
        <div id="glossaryEmpty" class="glossary-empty" style="display:none;">No matching terms.</div>
      </div>
    `;
  }

  function bindGlossaryPage(){
    const box = document.getElementById("glossarySearch");
    const list = document.getElementById("glossaryList");
    const empty = document.getElementById("glossaryEmpty");
    if (!box || !list) return;
    const render = () => {
      const q = box.value.trim().toLowerCase();
      const filtered = glossary.filter(item => {
        const text = [item.term, ...(item.aliases || []), item.short, item.long].join(" ").toLowerCase();
        return !q || text.includes(q);
      });
      list.innerHTML = "";
      empty.style.display = filtered.length ? "none" : "block";
      filtered.forEach(item => {
        const btn = document.createElement("button");
        btn.className = "glossary-item";
        btn.type = "button";
        btn.textContent = item.term;
        btn.addEventListener("click", () => openTooltip(item.term.toLowerCase(), btn, {centered:true}));
        list.appendChild(btn);
      });
    };
    box.addEventListener("input", render);
    render();
  }

  function positionTooltip(anchor, centered=false){
    const pad = 10;
    const tipRect = tooltipEl.getBoundingClientRect();
    if (centered){
      const x = Math.max(pad, (window.innerWidth - tipRect.width) / 2);
      const y = Math.max(pad, (window.innerHeight - tipRect.height) / 2);
      tooltipEl.style.left = `${x}px`;
      tooltipEl.style.top = `${y}px`;
      return;
    }
    const a = anchor.getBoundingClientRect();
    let left = a.right + 8;
    let top = a.top - tipRect.height - 8;
    if (left + tipRect.width > window.innerWidth - pad) left = a.left - tipRect.width - 8;
    if (left < pad) left = Math.min(window.innerWidth - tipRect.width - pad, Math.max(pad, a.left));
    if (top < pad) top = a.bottom + 8;
    if (top + tipRect.height > window.innerHeight - pad) top = Math.max(pad, window.innerHeight - tipRect.height - pad);
    tooltipEl.style.left = `${left}px`;
    tooltipEl.style.top = `${top}px`;
  }

  function openTooltip(termKey, anchor, opts={}){
    const item = glossaryByKey.get(termKey);
    if (!item) return;
    state.tooltipTermKey = termKey;
    tooltipEl.innerHTML = `
      <div class="tooltip-head">
        <h3 class="tooltip-title">${escapeHtml(item.term)}</h3>
        <button class="tooltip-close" type="button" aria-label="Close definition">✕</button>
      </div>
      <p class="tooltip-short">${escapeHtml(item.short || "")}</p>
      ${item.long ? `<button class="tooltip-more-btn" type="button">More...</button><div class="tooltip-more">${escapeHtml(item.long)}</div>` : ""}
      ${item.examples?.length ? `<pre>${escapeHtml(item.examples.join("\n"))}</pre>` : ""}
      ${item.seeAlso?.length ? `<div class="tooltip-see">${item.seeAlso.map(x=>`<button type="button" class="see-chip" data-see="${escapeHtml(x)}">${escapeHtml(x)}</button>`).join("")}</div>` : ""}
    `;
    tooltipEl.classList.add("open");
    tooltipEl.querySelector(".tooltip-close")?.addEventListener("click", closeTooltip);
    tooltipEl.querySelector(".tooltip-more-btn")?.addEventListener("click", (e) => {
      const more = tooltipEl.querySelector(".tooltip-more");
      more?.classList.toggle("open");
      e.target.textContent = more?.classList.contains("open") ? "Less" : "More...";
      positionTooltip(anchor || tooltipEl, !!opts.centered);
    });
    tooltipEl.querySelectorAll(".see-chip").forEach(btn => {
      btn.addEventListener("click", () => {
        const target = normalizeTerm(btn.dataset.see);
        if (target) openTooltip(target, anchor || btn, opts);
      });
    });
    positionTooltip(anchor || tooltipEl, !!opts.centered);
  }

  function closeTooltip(){
    tooltipEl.classList.remove("open");
    tooltipEl.innerHTML = "";
    state.tooltipTermKey = null;
  }

  // --- Render ---------------------------------------------------------------
  function renderChips(){
    const tags = uniqueTags();
    chiprowEl.innerHTML = "";
    tags.forEach(t => {
      const chip = document.createElement("div");
      chip.className = "chip" + (state.filterTag === t ? " active" : "");
      chip.textContent = t;
      chip.addEventListener("click", () => {
        state.filterTag = t;
        renderChips();
        applyFilters();
      });
      chiprowEl.appendChild(chip);
    });
  }

  function renderToc(){
    tocEl.innerHTML = "";
    countEl.textContent = `${state.visible.length}/${allLessons.length}`;

    const current = getCurrentLesson();
    state.visible.forEach(l => {
      const item = document.createElement("div");
      item.className = "toc-item" + (current && current.id === l.id ? " active" : "");
      item.setAttribute("tabindex", "0");
      const done = state.completedLessons.has(l.id) ? '<span class="complete-badge">✓</span>' : "";
      item.innerHTML = `
        <div class="kicker">${escapeHtml(l.module)}</div>
        <p class="title">${escapeHtml(l.title)} ${done}</p>
        <div class="meta">${escapeHtml(l.tags.join(" · "))}</div>
      `;
      item.addEventListener("click", () => {
        setCurrentById(l.id);
      });
      item.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          setCurrentById(l.id);
        }
      });
      tocEl.appendChild(item);
    });
  }

  function renderLesson(){
    const l = getCurrentLesson();
    if (!l){
      kickerEl.textContent = "No results";
      titleEl.textContent = "Try a different search or tag filter.";
      contentEl.innerHTML = `<div class="hint warn">No lessons match your filter.</div>`;
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      completeBtn.disabled = true;
      barEl.style.width = "0%";
      footerLeft.textContent = "";
      footerRight.textContent = "";
      closeTooltip();
      return;
    }

    kickerEl.textContent = l.module;
    titleEl.textContent = l.title;
    const raw = l.id === "glossary" ? createGlossaryPageHTML() : (l.id === "daily-drills" ? createDailyDrillsHTML() : l.content);
    contentEl.innerHTML = annotateTerms(raw, l.id) + renderQuizSection(l);
    if (l.id === "glossary") bindGlossaryPage();

    prevBtn.disabled = state.currentIndex <= 0;
    nextBtn.disabled = state.currentIndex >= state.visible.length - 1;
    updateLessonCompletion(l);
    completeBtn.disabled = l.id === "glossary" || l.id === "daily-drills";
    completeBtn.textContent = state.completedLessons.has(l.id) ? "Completed ✓" : "Mark complete ✓";

    const progress = state.visible.length ? (Array.from(state.completedLessons).filter(id => state.visible.some(v => v.id === id)).length / state.visible.length) * 100 : 0;
    barEl.style.width = `${progress}%`;

    footerLeft.textContent = `Lesson ${state.currentIndex + 1} of ${state.visible.length}`;
    footerRight.textContent = `Filter: ${state.filterTag} • Search: ${state.search ? '"' + state.search + '"' : "—"}`;
    document.body.classList.toggle("practice-on", state.practiceMode);
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // --- Events ---------------------------------------------------------------
  prevBtn.addEventListener("click", () => {
    if (state.currentIndex > 0) {
      state.currentIndex--;
      closeTooltip();
      renderLesson(); renderToc(); updateUrlHash();
    }
  });
  nextBtn.addEventListener("click", () => {
    if (state.currentIndex < state.visible.length - 1) {
      state.currentIndex++;
      closeTooltip();
      renderLesson(); renderToc(); updateUrlHash();
    }
  });

  completeBtn.addEventListener("click", () => {
    const l = getCurrentLesson();
    if (!l || l.id === "glossary" || l.id === "daily-drills") return;
    state.completedLessons.add(l.id);
    saveCompleted();
    renderLesson();
    renderToc();
  });

  practiceToggleBtn.addEventListener("click", () => {
    setPracticeMode(!state.practiceMode);
    renderLesson();
  });

  resetProgressBtn.addEventListener("click", () => {
    if (!confirm("Reset all completion and quiz progress?")) return;
    state.completedLessons = new Set();
    saveCompleted();
    lessons.forEach(l => localStorage.removeItem(lessonStorageKey(l.id)));
    renderLesson();
    renderToc();
  });

  searchEl.addEventListener("input", (e) => {
    state.search = e.target.value;
    applyFilters();
  });

  contentEl.addEventListener("click", (e) => {
    const l = getCurrentLesson();
    const term = e.target.closest(".term");
    if (term){
      openTooltip(term.dataset.term, term);
      return;
    }

    if (e.target.id === "newDrillBtn"){
      state.drillSeed = `${Date.now()}`;
      renderLesson();
      return;
    }

    const actionBtn = e.target.closest("[data-quiz-action]");
    if (!actionBtn || !l?.quiz?.length) return;
    const card = actionBtn.closest(".quiz-card");
    if (!card) return;
    const qIndex = Number(card.dataset.quizIndex);
    const question = l.quiz[qIndex];
    const quizState = readQuizState(l.id);
    const qState = quizState[qIndex] || {};

    if (question.type === "mcq") {
      const selected = card.querySelector("input[type='radio']:checked");
      qState.selectedIndex = selected ? Number(selected.dataset.quizChoice) : qState.selectedIndex;
    } else {
      const input = card.querySelector("[data-quiz-input]");
      qState.userAnswer = input ? input.value : (qState.userAnswer || "");
    }

    const action = actionBtn.dataset.quizAction;
    if (action === "check" && question.type === "mcq") {
      qState.checked = true;
      qState.correct = Number(qState.selectedIndex) === Number(question.answerIndex);
      qState.revealed = true;
    }
    if (action === "reveal") qState.revealed = true;
    if (action === "compare") qState.revealed = true;

    quizState[qIndex] = qState;
    writeQuizState(l.id, quizState);
    updateLessonCompletion(l);
    renderLesson();
    renderToc();
  });

  contentEl.addEventListener("input", (e) => {
    const l = getCurrentLesson();
    if (!l?.quiz?.length) return;
    const input = e.target.closest("[data-quiz-input], input[type='radio']");
    if (!input) return;
    const card = e.target.closest(".quiz-card");
    if (!card) return;
    const qIndex = Number(card.dataset.quizIndex);
    const quizState = readQuizState(l.id);
    const qState = quizState[qIndex] || {};
    if (input.matches("input[type='radio']")) {
      qState.selectedIndex = Number(input.dataset.quizChoice);
    } else {
      qState.userAnswer = input.value;
    }
    quizState[qIndex] = qState;
    writeQuizState(l.id, quizState);
  });

  contentEl.addEventListener("mouseover", (e) => {
    const term = e.target.closest(".term");
    if (term && window.matchMedia("(hover: hover)").matches){
      openTooltip(term.dataset.term, term);
    }
  });

  contentEl.addEventListener("keydown", (e) => {
    const term = e.target.closest(".term");
    if (!term) return;
    if (e.key === "Enter" || e.key === " "){
      e.preventDefault();
      openTooltip(term.dataset.term, term);
    }
  });

  document.addEventListener("click", (e) => {
    if (!tooltipEl.classList.contains("open")) return;
    if (tooltipEl.contains(e.target) || e.target.closest(".term") || e.target.closest(".glossary-item")) return;
    closeTooltip();
  });

  document.addEventListener("keydown", (e) => {
    const active = document.activeElement;
    const typing = active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA");
    if (!typing && e.key === "/"){
      e.preventDefault();
      searchEl.focus();
      return;
    }
    if (e.key === "Escape") closeTooltip();
    if (typing) return;

    if (e.key === "ArrowLeft") prevBtn.click();
    if (e.key === "ArrowRight") nextBtn.click();
    if (e.key === "j" || e.key === "J") {
      if (state.currentIndex < state.visible.length - 1) nextBtn.click();
    }
    if (e.key === "k" || e.key === "K") {
      if (state.currentIndex > 0) prevBtn.click();
    }
  });

  function initFromHash(){
    const id = decodeURIComponent((location.hash || "").replace("#","")).trim();
    if (!id) return;
    const idxAll = allLessons.findIndex(l => l.id === id);
    if (idxAll >= 0){
      state.currentIndex = 0;
      applyFilters();
      if (!state.visible.some(l => l.id === id)){
        state.filterTag = "All";
        state.search = "";
        searchEl.value = "";
        renderChips();
        applyFilters();
      }
      setCurrentById(id);
    }
  }

  // --- Boot -----------------------------------------------------------------
  setPracticeMode(state.practiceMode);
  renderChips();
  applyFilters();
  initFromHash();

</script>
</body>
</html>
